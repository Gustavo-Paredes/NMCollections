{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}NM Collections - Subastas{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/subastas.css' %}">
{% endblock %}

{% block content %}
<!-- Toast de error -->
<div id="nm-toast-container" style="position:fixed; top:20px; right:20px; z-index:11000; display:flex; flex-direction:column; gap:10px;"></div>

{% if error or form.errors or messages %}
<script>
function mostrarNotificacion(mensaje, tipo = 'error') {
    const tipos = {
        success: { icon: 'check-circle', clase: 'success' },
        error: { icon: 'times-circle', clase: 'danger' },
        warning: { icon: 'exclamation-triangle', clase: 'warning' },
        info: { icon: 'info-circle', clase: 'info' }
    };
    const t = tipos[tipo] || tipos.info;
    let contenedor = document.getElementById('nm-toast-container');
    if (!contenedor) {
        contenedor = document.createElement('div');
        contenedor.id = 'nm-toast-container';
        contenedor.style.cssText = 'position:fixed; top:20px; right:20px; z-index:11000; display:flex; flex-direction:column; gap:10px;';
        document.body.appendChild(contenedor);
    }
    const toast = document.createElement('div');
    toast.className = `alert alert-${t.clase} shadow-sm mb-0 py-2 px-3`;
    toast.style.cssText = 'min-width:260px;';
    toast.innerHTML = `<div class=\"d-flex align-items-start\"><i class=\"fas fa-${t.icon} me-2 mt-1\"></i><div class=\"flex-grow-1\">${mensaje}</div><button type=\"button\" class=\"btn-close ms-2\" style=\"font-size:10px\" aria-label=\"Cerrar\"></button></div>`;
    toast.querySelector('.btn-close').onclick = () => toast.remove();
    contenedor.appendChild(toast);
    setTimeout(() => toast.remove(), 7000);
}

window.addEventListener('DOMContentLoaded', function() {
    {% if error %}
        mostrarNotificacion({{ error|escapejs }}, 'error');
    {% endif %}
    {% if form.errors %}
        mostrarNotificacion('Error en el formulario: {{ form.errors.as_text|escapejs }}', 'error');
    {% endif %}
    {% if messages %}
        {% for message in messages %}
            mostrarNotificacion('{{ message|escapejs }}', '{{ message.tags|default:'info' }}');
        {% endfor %}
    {% endif %}
});
</script>
{% endif %}
<div class="container py-4">
    <div class="row">
        {% if user.is_superuser %}
        <!-- Columna izquierda: Crear subasta -->
        <div class="col-12 col-lg-4 mb-4">
            <div class="subasta-card">
                <div class="subasta-title" style="font-size:1.3rem; text-align:center;">CREAR SUBASTA</div>
                <form method="post" class="card-body crear-subasta-form rectangular-form">
                    {% csrf_token %}
                    <div class="form-group row">
                        <div class="form-group">
                            {{ form.producto.label_tag }}
                            {{ form.producto }}
                        </div>
                        <div class="form-group">
                            {{ form.precio_inicial.label_tag }}
                            {{ form.precio_inicial }}
                        </div>
                        <div class="form-group">
                            {{ form.incremento_minimo.label_tag }}
                            {{ form.incremento_minimo }}
                        </div>
                        {# Campo precio_reserva eliminado #}
                        <div class="form-field">
                            {{ form.fecha_inicio_fecha.label_tag }}
                            {{ form.fecha_inicio_fecha }}
                        </div>
                        <div class="form-field">
                            {{ form.fecha_inicio_hora.label_tag }}
                            {{ form.fecha_inicio_hora }}
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="form-field">
                            {{ form.fecha_fin_fecha.label_tag }}
                            {{ form.fecha_fin_fecha }}
                        </div>
                        <div class="form-field">
                            {{ form.fecha_fin_hora.label_tag }}
                            {{ form.fecha_fin_hora }}
                        </div>
                    </div>
                    <button type="submit" class="subasta-btn">Crear Subasta</button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Columna derecha: Subastas en lista -->
        <div class="col-12 col-lg-8">
            <h4 class="mb-4 subasta-title text-center">Lista de Subastas</h4>

            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Estado</th>
                            <th>Precio actual</th>
                            <th>Fecha inicio</th>
                            <th>Fecha fin</th>
                            <th>Tiempo restante</th>
                            {% if user.is_superuser %}<th>Acciones</th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for subasta in subastas %}
                        <tr>
                            <td>{{ subasta.producto.nombre }}</td>
                            <td>{{ subasta.get_estado_display }}</td>
                            <td>$ {{ subasta.precio_actual|default:subasta.precio_inicial|floatformat:0|intcomma }}</td>
                            <td>{{ subasta.fecha_inicio|date:'d/m/Y H:i' }}</td>
                            <td>{{ subasta.fecha_fin|date:'d/m/Y H:i' }}</td>
                            <td><span class="subasta-contador" data-fecha-inicio="{{ subasta.fecha_inicio|date:'Y-m-d\\TH:i:s' }}" data-fecha-fin="{{ subasta.fecha_fin|date:'Y-m-d\\TH:i:s' }}"></span></td>
                            {% if user.is_superuser %}
                            <td>
                                <div class="d-flex gap-2">
                                    <a href="{% url 'subastas:editar' subasta.id %}" class="btn btn-sm btn-outline-primary">Editar</a>
                                    <form method="post" action="{% url 'subastas:eliminar' subasta.id %}" style="display:inline-block;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                    </form>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7">No hay subastas disponibles.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function(){
        function pad(n){ return n<10? '0'+n : n; }

        function formatRemaining(ms){
            if(ms <= 0) return 'Finalizada';
            var total = Math.floor(ms/1000);
            var days = Math.floor(total / 86400);
            var hours = Math.floor((total % 86400) / 3600);
            var mins = Math.floor((total % 3600) / 60);
            var secs = total % 60;
            var parts = [];
            if(days>0) parts.push(days + 'd');
            parts.push(pad(hours) + 'h');
            parts.push(pad(mins) + 'm');
            parts.push(pad(secs) + 's');
            return parts.join(' ');
        }

        function updateTimers(){
            var nodes = document.querySelectorAll('.subasta-contador');
            if(!nodes) return;
            var now = new Date();
            nodes.forEach(function(node){
                var fechaFin = node.getAttribute('data-fecha-fin');
                if(!fechaFin) return;
                // parse as local datetime
                var end = new Date(fechaFin);
                var diff = end - now;
                if(diff <= 0){
                    node.textContent = 'Finalizada';
                } else {
                    node.textContent = 'Termina en: ' + formatRemaining(diff);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            updateTimers();
            setInterval(updateTimers, 1000);
        });
    })();
</script>
{% endblock %}
