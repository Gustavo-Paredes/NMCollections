{% extends 'base/base.html' %}
{% load static %}

{% block title %}Detalle Pedido {{ pedido.numero_pedido }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/nm-dark-theme.css' %}">
<link rel="stylesheet" href="{% static 'css/detalle_pedido_admin.css' %}">
{% endblock %}

{% block content %}
{% include 'base/navbar.html' %}

<div class="container-fluid py-4" style="background-color: var(--negro-principal); min-height: 100vh;">
    <div class="container">
        <!-- Encabezado -->
        <div class="row mb-4">
            <div class="col-12">
                <a href="{% url 'pedidos:panel_pedidos' %}" class="btn btn-outline-success mb-3">
                    <i class="fas fa-arrow-left"></i> Volver al Panel
                </a>
                <h1 class="text-white mb-2">
                    <i class="fas fa-file-invoice"></i> Pedido {{ pedido.numero_pedido }}
                </h1>
            </div>
        </div>

        <div class="row">
            <!-- Información del Pedido -->
            <div class="col-md-6">
                <div class="detalle-container">
                    <h3 class="text-success mb-4">
                        <i class="fas fa-info-circle"></i> Información del Pedido
                    </h3>
                    
                    <div class="info-card">
                        <div class="info-label">Código del Pedido</div>
                        <div class="info-value">{{ pedido.numero_pedido }}</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Fecha</div>
                        <div class="info-value">{{ pedido.fecha_pedido|date:"d/m/Y H:i" }}</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Estado</div>
                        <div class="info-value">
                            <span class="badge badge-{{ pedido.estado }} px-3 py-2">
                                {{ pedido.get_estado_display }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Total</div>
                        <div class="info-value text-success">
                            {% if pedido.total %}
                                ${{ pedido.total|floatformat:0 }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Método de Pago</div>
                        <div class="info-value">{{ pedido.metodo_pago|default:"No especificado" }}</div>
                    </div>
                    
                    {% if pedido.direccion_envio %}
                    <div class="info-card">
                        <div class="info-label">Dirección de Envío</div>
                        <div class="info-value">{{ pedido.direccion_envio }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Información del Cliente -->
            <div class="col-md-6">
                <div class="detalle-container">
                    <h3 class="text-success mb-4">
                        <i class="fas fa-user"></i> Información del Cliente
                    </h3>
                    
                    <div class="info-card">
                        <div class="info-label">Nombre</div>
                        <div class="info-value">
                            {{ pedido.usuario.first_name }} {{ pedido.usuario.last_name }}
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">Email</div>
                        <div class="info-value">
                            <a href="mailto:{{ pedido.usuario.email }}" class="text-success">
                                {{ pedido.usuario.email }}
                            </a>
                        </div>
                    </div>
                    
                    <!-- Acciones rápidas -->
                    <div class="mt-4">
                        <h5 class="text-white mb-3">Acciones</h5>
                        <div class="d-grid gap-2">
                            <a href="{% url 'pedidos:descargar_pedido_pdf' pedido.id %}" 
                               class="btn btn-danger">
                                <i class="fas fa-file-pdf"></i> Descargar PDF
                            </a>
                            <button type="button" class="btn btn-success" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalMensaje">
                                <i class="fas fa-envelope"></i> Contactar Cliente
                            </button>
                            <button type="button" class="btn btn-warning" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalEstado">
                                <i class="fas fa-edit"></i> Cambiar Estado
                            </button>
                            <button type="button" class="btn btn-outline-danger" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalEliminar">
                                <i class="fas fa-trash"></i> Eliminar Pedido
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productos del Pedido -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="detalle-container">
                    <h3 class="text-success mb-4">
                        <i class="fas fa-box-open"></i> Productos
                    </h3>
                    
                    {% for producto_data in productos_personalizados %}
                    <div class="producto-item">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                {% if producto_data.carta and producto_data.carta.imagen_frente %}
                                    <img src="{{ producto_data.carta.imagen_frente.url }}" 
                                         class="carta-preview img-fluid" 
                                         alt="Carta">
                                {% else %}
                                    <div class="carta-preview bg-secondary d-flex align-items-center justify-content-center" 
                                         style="height: 150px;">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-white">{{ producto_data.item.producto.nombre }}</h5>
                                <p class="text-muted mb-2">Cantidad: {{ producto_data.item.cantidad }}</p>
                                {% if producto_data.carta %}
                                    <p class="text-success mb-2">
                                        <i class="fas fa-check-circle"></i> Carta Personalizada: {{ producto_data.carta.nombre_carta }}
                                    </p>
                                    {% if producto_data.parametros %}
                                        <small class="text-muted">
                                            Parámetros: 
                                            {% for param in producto_data.parametros %}
                                                {{ param.nombre_parametro }}: {{ param.valor }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="text-muted">Precio unitario</div>
                                <div class="text-white h5">
                                    ${{ producto_data.item.precio_total|floatformat:0 }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                        {% for item in pedido.productos.all %}
                        <div class="producto-item">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="text-white">{{ item.producto.nombre }}</h5>
                                    <p class="text-muted mb-0">Cantidad: {{ item.cantidad }}</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="text-muted">Subtotal</div>
                                    <div class="text-white h5">
                                        ${{ item.precio_total|floatformat:0 }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}
                    
                    <div class="text-end mt-4 pt-4 border-top border-secondary">
                        <h4 class="text-white">
                            Total: <span class="text-success">${{ pedido.total|floatformat:0 }}</span>
                        </h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de Estados -->
        {% if historial %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="detalle-container">
                    <h3 class="text-success mb-4">
                        <i class="fas fa-history"></i> Historial de Estados
                    </h3>
                    <div class="timeline">
                        {% for estado in historial %}
                        <div class="info-card">
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">{{ estado.fecha_cambio|date:"d/m/Y H:i" }}</small>
                                </div>
                                <div class="col-md-6">
                                    <span class="badge badge-{{ estado.estado_nuevo }}">
                                        {{ estado.get_estado_nuevo_display }}
                                    </span>
                                    {% if estado.comentarios %}
                                        <p class="text-muted mb-0 mt-2">{{ estado.comentarios }}</p>
                                    {% endif %}
                                </div>
                                <div class="col-md-3 text-end">
                                    {% if estado.usuario_cambio %}
                                        <small class="text-muted">Por: {{ estado.usuario_cambio.first_name }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Enviar Mensaje -->
<div class="modal fade" id="modalMensaje" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-envelope"></i> Contactar Cliente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pedidos:enviar_mensaje_cliente' pedido.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Asunto</label>
                        <input type="text" name="asunto" class="form-control" 
                               placeholder="Ej: Actualización de tu pedido" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mensaje</label>
                        <textarea name="mensaje" class="form-control" rows="5" 
                                  placeholder="Escribe tu mensaje aquí..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Cambiar Estado -->
<div class="modal fade" id="modalEstado" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Cambiar Estado del Pedido
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pedidos:cambiar_estado_pedido' pedido.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nuevo Estado</label>
                        <select name="nuevo_estado" class="form-select" required>
                            {% for valor, nombre in estados %}
                                <option value="{{ valor }}" {% if pedido.estado == valor %}selected{% endif %}>
                                    {{ nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comentarios (opcional)</label>
                        <textarea name="comentarios" class="form-control" rows="3" 
                                  placeholder="Notas adicionales..."></textarea>
                    </div>
                    <div class="mb-3" id="numeroSeguimientoDiv" style="display: none;">
                        <label class="form-label">Número de Seguimiento</label>
                        <input type="text" name="numero_seguimiento" class="form-control" 
                               placeholder="Ej: TRACK123456">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar Pedido -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-trash"></i> Confirmar eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pedidos:eliminar_pedido' pedido.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>¿Seguro que deseas eliminar el pedido <strong>{{ pedido.numero_pedido }}</strong>?</p>
                    <p class="text-warning small mb-0"><i class="fas fa-exclamation-triangle"></i> Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Mostrar campo de número de seguimiento si el estado es "enviado"
    document.querySelector('select[name="nuevo_estado"]').addEventListener('change', function() {
        const seguimientoDiv = document.getElementById('numeroSeguimientoDiv');
        if (this.value === 'enviado') {
            seguimientoDiv.style.display = 'block';
        } else {
            seguimientoDiv.style.display = 'none';
        }
    });
</script>
{% endblock %}
