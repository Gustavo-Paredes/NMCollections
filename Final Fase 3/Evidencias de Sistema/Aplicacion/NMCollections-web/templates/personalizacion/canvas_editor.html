{% extends 'base/base.html' %}
{% load static %}

{% block title %}Editor de Trading Cards - NM Collections{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/nm-dark-theme.css' %}">
<link rel="stylesheet" href="{% static 'css/personalizacion_canvas.css' %}">
<style>
    body {
        background: #585e60 !important;
        background-color: #585e60 !important;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    {% include 'base/navbar.html' %}

    <div class="editor-container d-flex flex-row">
            <!-- Sidebar tipo tabs verticales -->
            <aside class="editor-sidebar d-flex flex-column align-items-center py-4 px-2">
                <nav class="nav flex-column nav-pills w-100 mb-4" id="sidebarTabs" role="tablist">
                    <button class="nav-link active" id="tab-plantillas" data-bs-toggle="pill" data-bs-target="#panel-plantillas" type="button" role="tab">
                        <i class="fas fa-layer-group fa-lg"></i><br><span class="d-none d-md-inline">Plantillas</span>
                    </button>
                    <button class="nav-link" id="tab-imagenes" data-bs-toggle="pill" data-bs-target="#panel-imagenes" type="button" role="tab" disabled>
                        <i class="fas fa-image fa-lg"></i><br><span class="d-none d-md-inline">Imágenes</span>
                    </button>
                    <button class="nav-link" id="tab-texto" data-bs-toggle="pill" data-bs-target="#panel-texto" type="button" role="tab">
                        <i class="fas fa-font fa-lg"></i><br><span class="d-none d-md-inline">Texto</span>
                    </button>
                    <button class="nav-link" id="tab-formas" data-bs-toggle="pill" data-bs-target="#panel-formas" type="button" role="tab" disabled>
                        <i class="fas fa-shapes fa-lg"></i><br><span class="d-none d-md-inline">Formas</span>
                    </button>
                    <button class="nav-link" id="tab-capas" data-bs-toggle="pill" data-bs-target="#panel-capas" type="button" role="tab" disabled>
                        <i class="fas fa-layer-group fa-lg"></i><br><span class="d-none d-md-inline">Capas</span>
                    </button>
                </nav>
                <!-- Paneles de contenido -->
                <div class="tab-content w-100 flex-grow-1" id="sidebarTabContent">
                    <div class="tab-pane fade show active" id="panel-plantillas" role="tabpanel">
                        <h6 class="mb-3 text-center"><i class="fas fa-layer-group"></i> Plantillas Disponibles</h6>
                        <div id="plantillasContainer"></div>
                    </div>
                    <div class="tab-pane fade" id="panel-imagenes" role="tabpanel">
                        <h6 class="mb-3 text-center"><i class="fas fa-image"></i> Imágenes</h6>
                        <div id="imagenesContainer">
                            <!-- Subir imagen personalizada -->
                            <div class="mb-3">
                                <label class="form-label text-white">Subir Imagen</label>
                                <input type="file" 
                                       id="imagenPersonalizada" 
                                       class="form-control form-control-sm" 
                                       accept="image/*"
                                       onchange="subirImagenPersonalizada(this.files[0])">
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle"></i> Se recortará automáticamente
                                </small>
                            </div>
                            
                            <!-- Preview de la imagen -->
                            <div id="previewImagenPersonalizada" style="display: none;" class="mt-3">
                                <img id="imgPreview" class="img-fluid rounded" style="max-height: 150px;">
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-success w-100" onclick="aplicarImagenAlCanvas()">
                                        <i class="fas fa-check"></i> Aplicar al Canvas
                                    </button>
                                    <button class="btn btn-sm btn-warning w-100 mt-1" onclick="aplicarRecorteInteligente()">
                                        <i class="fas fa-magic"></i> Recorte Automático de Persona
                                    </button>
                                    <button class="btn btn-sm btn-danger w-100 mt-1" onclick="limpiarImagenPersonalizada()">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Opciones de ajuste -->
                            <div id="opcionesImagen" style="display: none;" class="mt-3">
                                <label class="form-label text-white">Ajustar Imagen</label>
                                <div class="btn-group-vertical w-100">
                                    <button class="btn btn-sm btn-outline-light" onclick="ajustarImagenEnCanvas('center')">
                                        <i class="fas fa-compress-arrows-alt"></i> Centrar
                                    </button>
                                    <button class="btn btn-sm btn-outline-light" onclick="ajustarImagenEnCanvas('fill')">
                                        <i class="fas fa-expand-arrows-alt"></i> Llenar
                                    </button>
                                    <button class="btn btn-sm btn-outline-light" onclick="ajustarImagenEnCanvas('fit')">
                                        <i class="fas fa-compress"></i> Ajustar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="panel-texto" role="tabpanel">
                        <h6 class="mb-3 text-center"><i class="fas fa-font"></i> Texto Personalizado</h6>
                        <div id="textoContainer">
                            <div class="mb-3">
                                <label for="textoInput" class="form-label">Texto</label>
                                <textarea class="form-control" id="textoInput" rows="3" placeholder="Escribe tu texto aquí..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="fuenteSelect" class="form-label">Fuente</label>
                                <select class="form-select" id="fuenteSelect">
                                    <option value="Arial">Arial</option>
                                    <option value="Verdana">Verdana</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Courier New">Courier New</option>
                                    <option value="Impact">Impact</option>
                                    <option value="Comic Sans MS">Comic Sans MS</option>
                                    <option value="Trebuchet MS">Trebuchet MS</option>
                                    <option value="Arial Black">Arial Black</option>
                                    <option value="Palatino">Palatino</option>
                                </select>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="tamañoTexto" class="form-label">Tamaño</label>
                                    <input type="number" class="form-control" id="tamañoTexto" value="24" min="8" max="200">
                                </div>
                                <div class="col-md-6">
                                    <label for="colorTexto" class="form-label">Color</label>
                                    <input type="color" class="form-control form-control-color" id="colorTexto" value="#000000">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Estilo</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="checkbox" class="btn-check" id="textoNegrita" autocomplete="off">
                                    <label class="btn btn-outline-success" for="textoNegrita">
                                        <i class="fas fa-bold"></i> Negrita
                                    </label>
                                    
                                    <input type="checkbox" class="btn-check" id="textoCursiva" autocomplete="off">
                                    <label class="btn btn-outline-success" for="textoCursiva">
                                        <i class="fas fa-italic"></i> Cursiva
                                    </label>
                                    
                                    <input type="checkbox" class="btn-check" id="textoSubrayado" autocomplete="off">
                                    <label class="btn btn-outline-success" for="textoSubrayado">
                                        <i class="fas fa-underline"></i> Subrayado
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Alineación</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="alineacionTexto" id="alineacionIzquierda" value="left" checked autocomplete="off">
                                    <label class="btn btn-outline-success" for="alineacionIzquierda">
                                        <i class="fas fa-align-left"></i>
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="alineacionTexto" id="alineacionCentro" value="center" autocomplete="off">
                                    <label class="btn btn-outline-success" for="alineacionCentro">
                                        <i class="fas fa-align-center"></i>
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="alineacionTexto" id="alineacionDerecha" value="right" autocomplete="off">
                                    <label class="btn btn-outline-success" for="alineacionDerecha">
                                        <i class="fas fa-align-right"></i>
                                    </label>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-success w-100" onclick="agregarTextoAlCanvas()">
                                <i class="fas fa-plus"></i> Agregar Texto al Canvas
                            </button>
                            
                            <hr class="my-3">
                            
                            <div id="textoSeleccionadoControles" style="display: none;">
                                <h6 class="mb-3">Texto Seleccionado</h6>
                                <button type="button" class="btn btn-outline-danger w-100" onclick="eliminarTextoSeleccionado()">
                                    <i class="fas fa-trash"></i> Eliminar Texto
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="panel-formas" role="tabpanel">
                        <h6 class="mb-3 text-center"><i class="fas fa-shapes"></i> Formas</h6>
                        <div id="formasContainer"><!-- Aquí puedes agregar controles para formas --></div>
                    </div>
                    <div class="tab-pane fade" id="panel-capas" role="tabpanel">
                        <h6 class="mb-3 text-center"><i class="fas fa-layer-group"></i> Capas</h6>
                        <div id="capasContainer"><!-- Aquí puedes mostrar la lista de capas del canvas --></div>
                    </div>
                </div>
                <!-- Control de escalado del marco -->
                <div class="element-input w-100 mt-3" id="marcoControls" style="display: none;">
                    <label>Escalado del Marco</label>
                    <select id="tipoEscalado" onchange="cambiarEscaladoMarco(this.value)">
                        <option value="ajustar" selected>Mantener proporción</option>
                        <option value="llenar">Llenar canvas completo</option>
                    </select>
                </div>
                <!-- Botones de acción -->
                <div class="action-buttons w-100 mt-auto">
                    <button class="btn nm-btn-primary w-100 mb-2" onclick="finalizarCarta()">
                        <i class="fas fa-check-circle"></i> Finalizar Carta
                    </button>
                    <button class="btn nm-btn-secondary w-100 mb-2" onclick="guardarCarta()">
                        <i class="fas fa-save"></i> Guardar Borrador
                    </button>
                    <button class="btn btn-danger w-100" onclick="limpiarCanvas()">
                        <i class="fas fa-trash"></i> Limpiar
                    </button>
                </div>
            </aside>
            <!-- Área central del editor -->
            <main class="editor-main flex-grow-1 d-flex flex-column align-items-center justify-content-center position-relative p-4">
                <!-- Nombre de la carta -->
                <div class="position-absolute top-0 start-50 translate-middle-x mt-2" style="z-index: 3;">
                    <div class="element-input mb-0">
                        <input type="text" id="nombreCarta" placeholder="Mi Trading Card" value="Mi Trading Card" 
                               class="form-control text-center" 
                               style="background: rgba(26,26,26,0.95); border: 2px solid var(--verde-principal); color: white; font-weight: 600; min-width: 300px;">
                    </div>
                </div>
                <!-- Controles flotantes arriba del canvas -->
                <div class="canvas-container d-flex flex-column align-items-center justify-content-center w-100" style="position: relative; z-index: 1;">
                    <h4 class="mb-3"><i class="fas fa-magic"></i> Canvas de Diseño</h4>

                    
                    <!-- Canvas Frente -->
                    <div id="canvas-frente" class="canvas-wrapper-container" style="display: flex; flex-direction: column; align-items: center;">
                        <canvas id="cardCanvas" class="card-canvas" width="320" height="420"></canvas>
                        <small class="text-muted mt-2">
                            <i class="fas fa-info-circle"></i> Cara delantera - 320x420px
                        </small>
                    </div>

                </div>
            </main>
        </div>
{% endblock %}

{% block extra_js %}
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Librerías necesarias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Canvas Editor JavaScript -->
    <script src="{% static 'js/canvas-editor.js' %}"></script>
{% endblock %}