{% extends 'base/base.html' %}
{% load static %}

{% block title %}Crear Plantilla - Panel de Diseñador{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="dashboard-main-card admin-section">
        <div class="dashboard-header text-center">
            <h1><i class="fas fa-plus-circle"></i> Crear Nueva Plantilla</h1>
            <p class="mb-0">Diseña una nueva plantilla para el canvas editor</p>
        </div>
        <div class="dashboard-grid">
            <div class="dashboard-card-inner" style="width:100%;max-width:900px;margin:auto;">
                <form method="post" enctype="multipart/form-data" id="plantillaForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.nombre.id_for_label }}">
                                    <i class="fas fa-tag"></i> Nombre de la Plantilla *
                                </label>
                                {{ form.nombre }}
                                {% if form.nombre.errors %}
                                    <div class="text-danger">{{ form.nombre.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group mb-3">
                                <label for="{{ form.tipo_carta.id_for_label }}">
                                    <i class="fas fa-layer-group"></i> Tipo de Carta
                                </label>
                                {{ form.tipo_carta }}
                                <div class="help-text">Ej: pokemon, yugioh, magic, etc.</div>
                                {% if form.tipo_carta.errors %}
                                    <div class="text-danger">{{ form.tipo_carta.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group mb-3">
                                <label for="{{ form.diseñador.id_for_label }}">
                                    <i class="fas fa-user"></i> Diseñador
                                </label>
                                {{ form.diseñador }}
                                {% if form.diseñador.errors %}
                                    <div class="text-danger">{{ form.diseñador.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group mb-3">
                                <label for="{{ form.estado.id_for_label }}">
                                    <i class="fas fa-toggle-on"></i> Estado
                                </label>
                                {{ form.estado }}
                                {% if form.estado.errors %}
                                    <div class="text-danger">{{ form.estado.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.imagen_marco.id_for_label }}">
                                    <i class="fas fa-image"></i> Imagen del Marco *
                                </label>
                                {{ form.imagen_marco }}
                                <div class="help-text">Sube la imagen de marco/fondo que diseñaste</div>
                                {% if form.imagen_marco.errors %}
                                    <div class="text-danger">{{ form.imagen_marco.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="dashboard-preview" id="imagePreview" style="background:#f8f9fa;min-height:220px;max-width:100%;display:flex;align-items:center;justify-content:center;margin-top:1rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);overflow:hidden;">
                                <div class="text-muted" style="text-align:center;">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                    <p style="margin-bottom:0;">Vista previa de la imagen</p>
                                </div>
                            </div>
                            <div style="background:#f8f9fa;padding:1rem;border-radius:10px;margin-bottom:1rem;">
                                <h6><i class="fas fa-ruler-combined"></i> Dimensiones del Marco</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="{{ form.ancho_marco.id_for_label }}">Ancho (px)</label>
                                        {{ form.ancho_marco }}
                                        {% if form.ancho_marco.errors %}
                                            <div class="text-danger">{{ form.ancho_marco.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-6">
                                        <label for="{{ form.alto_marco.id_for_label }}">Alto (px)</label>
                                        {{ form.alto_marco }}
                                        {% if form.alto_marco.errors %}
                                            <div class="text-danger">{{ form.alto_marco.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-4">
                        <label for="{{ form.descripcion.id_for_label }}">
                            <i class="fas fa-align-left"></i> Descripción
                        </label>
                        {{ form.descripcion }}
                        <div class="help-text">Describe el propósito y características de esta plantilla</div>
                        {% if form.descripcion.errors %}
                            <div class="text-danger">{{ form.descripcion.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="dashboard-section" style="margin-top:2rem;">
                        <h3><i class="fas fa-puzzle-piece"></i> Elementos de la Plantilla</h3>
                        <p class="text-muted">Define los elementos que los usuarios podrán personalizar</p>
                        <div id="elementos-container"></div>
                        <button type="button" class="btn-dashboard admin-btn mb-3" onclick="agregarElemento()">
                            <i class="fas fa-plus"></i> Agregar Elemento
                        </button>
                        <input type="hidden" id="elemento_count" name="elemento_count" value="0">
                    </div>
                    <div class="text-center" style="margin-top:2rem;">
                        <a href="{% url 'personalizacion:panel_diseñador' %}" class="btn-dashboard admin-btn me-3">
                            <i class="fas fa-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn-dashboard admin-btn">
                            <i class="fas fa-save"></i> Crear Plantilla
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let elementoCount = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Preview de imagen
    const imageInput = document.getElementById('{{ form.imagen_marco.id_for_label }}');
    const previewArea = document.getElementById('imagePreview');
    
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewArea.innerHTML = `<img src="${e.target.result}" alt="Preview" class="preview-image">`;
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Validación de formulario
    document.getElementById('plantillaForm').addEventListener('submit', function(e) {
        const nombre = document.getElementById('{{ form.nombre.id_for_label }}').value;
        
        if (!nombre.trim()) {
            e.preventDefault();
            alert('Por favor, ingresa un nombre para la plantilla');
            return false;
        }
        
        // Actualizar contador de elementos
        document.getElementById('elemento_count').value = elementoCount;
    });
    
    // Agregar un elemento por defecto al cargar
    setTimeout(() => {
        agregarElemento();
    }, 100);
});

function agregarElemento() {
    const container = document.getElementById('elementos-container');
    const elementoHtml = `
        <div class="elemento-item" id="elemento_${elementoCount}">
            <button type="button" class="btn-remove-element" onclick="eliminarElemento(${elementoCount})">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="elemento-header">
                <h5 class="elemento-titulo">Elemento ${elementoCount + 1}</h5>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label>Nombre del Parámetro *</label>
                        <input type="text" name="elemento_${elementoCount}_nombre" class="form-control" 
                               placeholder="Ej: nombre_pokemon, ataque, descripcion" required>
                        <div class="help-text">Este será el nombre del campo que el usuario podrá editar</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label>Tipo de Elemento *</label>
                        <select name="elemento_${elementoCount}_tipo" class="form-control" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="texto">Texto</option>
                            <option value="imagen">Imagen</option>
                            <option value="numero">Número</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label>Posición X</label>
                        <input type="number" name="elemento_${elementoCount}_x" class="form-control" 
                               value="50" min="0" max="1000">
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label>Posición Y</label>
                        <input type="number" name="elemento_${elementoCount}_y" class="form-control" 
                               value="50" min="0" max="1000">
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label>Ancho</label>
                        <input type="number" name="elemento_${elementoCount}_ancho" class="form-control" 
                               value="200" min="10" max="1000">
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label>Alto</label>
                        <input type="number" name="elemento_${elementoCount}_alto" class="form-control" 
                               value="30" min="10" max="1000">
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', elementoHtml);
    elementoCount++;
}

function eliminarElemento(index) {
    const elemento = document.getElementById(`elemento_${index}`);
    if (elemento) {
        elemento.remove();
    }
}
</script>
{% endblock %}