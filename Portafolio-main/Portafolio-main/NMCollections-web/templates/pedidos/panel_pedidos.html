{% extends 'base/base.html' %}
{% load static %}

{% block title %}Panel de Pedidos - Administración{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/nm-dark-theme.css' %}">
<style>
    .stats-card {
        background: linear-gradient(135deg, var(--gris-oscuro) 0%, var(--negro-principal) 100%);
        border-radius: 15px;
        padding: 1.5rem;
        border: 2px solid var(--verde-principal);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: transform 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-card h3 {
        color: var(--verde-principal);
        font-size: 2rem;
        font-weight: bold;
        margin: 0;
    }
    
    .stats-card p {
        color: var(--texto-gris);
        margin: 0.5rem 0 0 0;
    }
    
    .pedidos-table {
        background: var(--gris-oscuro);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .table-dark {
        margin: 0;
    }
    
    .table-dark thead th {
        background-color: var(--negro-principal);
        color: var(--verde-principal);
        border-bottom: 2px solid var(--verde-principal);
        font-weight: 600;
    }
    
    .table-dark tbody tr {
        border-bottom: 1px solid var(--gris-medio);
    }
    
    .table-dark tbody tr:hover {
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    .badge-estado {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-pendiente {
        background-color: #ffc107;
        color: #000;
    }
    
    .badge-confirmado {
        background-color: #17a2b8;
        color: #fff;
    }
    
    .badge-enviado {
        background-color: #007bff;
        color: #fff;
    }
    
    .badge-entregado {
        background-color: #28a745;
        color: #fff;
    }
    
    .badge-cancelado {
        background-color: #dc3545;
        color: #fff;
    }
    
    .filtros-container {
        background: var(--gris-oscuro);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--gris-medio);
    }
    
    .btn-accion {
        padding: 0.4rem 0.8rem;
        margin: 0 0.2rem;
        border-radius: 8px;
        font-size: 0.85rem;
    }

    /* Toast notifications en esquina inferior izquierda */
    .toast-container {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 9999;
    }

    .custom-toast {
        min-width: 300px;
        max-width: 500px;
        background: var(--gris-oscuro);
        border: 2px solid var(--verde-principal);
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        margin-bottom: 10px;
        animation: slideInLeft 0.3s ease-out;
    }

    @keyframes slideInLeft {
        from {
            transform: translateX(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .custom-toast .toast-header {
        background: var(--negro-principal);
        color: var(--verde-principal);
        border-bottom: 1px solid var(--verde-principal);
        font-weight: 600;
    }

    .custom-toast .toast-body {
        color: var(--texto-gris);
        background: var(--gris-oscuro);
    }

    .custom-toast.toast-success {
        border-color: #28a745;
    }

    .custom-toast.toast-success .toast-header {
        color: #28a745;
        border-bottom-color: #28a745;
    }

    .custom-toast.toast-error {
        border-color: #dc3545;
    }

    .custom-toast.toast-error .toast-header {
        color: #dc3545;
        border-bottom-color: #dc3545;
    }

    .custom-toast.toast-warning {
        border-color: #ffc107;
    }

    .custom-toast.toast-warning .toast-header {
        color: #ffc107;
        border-bottom-color: #ffc107;
    }

    .custom-toast.toast-info {
        border-color: #17a2b8;
    }

    .custom-toast.toast-info .toast-header {
        color: #17a2b8;
        border-bottom-color: #17a2b8;
    }
</style>
{% endblock %}

{% block content %}
{% include 'base/navbar.html' %}

<!-- Contenedor de toasts en esquina inferior izquierda -->
<div class="toast-container">
    {% if messages %}
        {% for message in messages %}
        <div class="toast custom-toast toast-{{ message.tags }} show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="5000">
            <div class="toast-header">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' or message.tags == 'danger' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                <strong class="me-auto">
                    {% if message.tags == 'success' %}Éxito{% elif message.tags == 'error' or message.tags == 'danger' %}Error{% elif message.tags == 'warning' %}Advertencia{% else %}Información{% endif %}
                </strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                {{ message }}
            </div>
        </div>
        {% endfor %}
    {% endif %}
</div>

<div class="container-fluid py-4" style="background-color: var(--negro-principal); min-height: 100vh;">
    <div class="container">


        <!-- Filtros -->
        <div class="filtros-container">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label text-white">Estado</label>
                    <select name="estado" class="form-select">
                        <option value="">Todos</option>
                        {% for valor, nombre in estados %}
                            <option value="{{ valor }}" {% if estado_filtro == valor %}selected{% endif %}>
                                {{ nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-white">Búsqueda</label>
                    <input type="text" name="busqueda" class="form-control" 
                           placeholder="Código, cliente, email..." value="{{ busqueda }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label text-white">Desde</label>
                    <input type="date" name="fecha_desde" class="form-control" value="{{ fecha_desde }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label text-white">Hasta</label>
                    <input type="date" name="fecha_hasta" class="form-control" value="{{ fecha_hasta }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>

        <!-- Acciones masivas -->
        <div class="row align-items-end mb-2">
            <div class="col-md-3">
                <label class="form-label text-white">Acción masiva</label>
                <select name="accion" id="accionMasiva" class="form-select">
                    <option value="">Selecciona una acción</option>
                    <option value="cambiar_estado">Cambiar estado</option>
                    <option value="eliminar">Eliminar seleccionados</option>
                </select>
            </div>
            <div class="col-md-3" id="nuevoEstadoWrap" style="display:none;">
                <label class="form-label text-white">Nuevo estado</label>
                <select name="nuevo_estado" id="nuevoEstado" class="form-select">
                    {% for valor, nombre in estados %}
                        <option value="{{ valor }}">{{ nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3" id="seguimientoWrap" style="display:none;">
                <label class="form-label text-white">Número de seguimiento</label>
                <input type="text" name="numero_seguimiento" id="numeroSeguimiento" class="form-control" placeholder="Opcional">
            </div>
            <div class="col-md-3">
                <button type="button" id="btnAplicarAccion" class="btn btn-success w-100">
                    <i class="fas fa-check"></i> Aplicar a seleccionados
                </button>
            </div>
        </div>

        <form id="accionesMasivasForm" method="post" action="{% url 'pedidos:acciones_masivas_pedidos' %}" style="display:none;">
            {% csrf_token %}
            <input type="hidden" name="accion" id="hiddenAccion">
            <input type="hidden" name="nuevo_estado" id="hiddenNuevoEstado">
            <input type="hidden" name="numero_seguimiento" id="hiddenNumeroSeguimiento">
            <div id="hiddenCheckboxes"></div>
        </form>

        <!-- Tabla de Pedidos -->
        <div class="pedidos-table">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width:36px;">
                            <input type="checkbox" id="selectAll" />
                        </th>
                        <th>Código</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pedido in pedidos %}
                    <tr>
                        <td>
                            <input type="checkbox" class="pedido-checkbox" data-pedido-id="{{ pedido.id }}" />
                        </td>
                            <td>
                                <strong class="text-success">{{ pedido.numero_pedido }}</strong>
                            </td>
                            <td>
                                <div>
                                    <strong class="text-white">{{ pedido.usuario.first_name }} {{ pedido.usuario.last_name }}</strong>
                                </div>
                                <small class="text-muted">{{ pedido.usuario.email }}</small>
                            </td>
                            <td>
                                <div class="text-white">{{ pedido.fecha_pedido|date:"d/m/Y" }}</div>
                                <small class="text-muted">{{ pedido.fecha_pedido|date:"H:i" }}</small>
                            </td>
                            <td>
                                <strong class="text-success">
                                    {% if pedido.total %}
                                        ${{ pedido.total|floatformat:0 }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </strong>
                            </td>
                            <td>
                                <span class="badge badge-estado badge-{{ pedido.estado }}">
                                    {{ pedido.get_estado_display }}
                                </span>
                            </td>
                            <td>
                                <a href="{% url 'pedidos:detalle_pedido_admin' pedido.id %}" 
                                   class="btn btn-sm btn-info btn-accion" title="Ver Detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'pedidos:descargar_pedido_pdf' pedido.id %}" 
                                   class="btn btn-sm btn-danger btn-accion" title="Descargar PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-success btn-accion" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalMensaje{{ pedido.id }}"
                                        title="Contactar Cliente">
                                    <i class="fas fa-envelope"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-accion" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalEliminar{{ pedido.id }}"
                                        title="Eliminar Pedido">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>

                        <!-- Modal para enviar mensaje -->
                        <div class="modal fade" id="modalMensaje{{ pedido.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content bg-dark text-white">
                                    <div class="modal-header border-secondary">
                                        <h5 class="modal-title">
                                            <i class="fas fa-envelope"></i> Contactar Cliente
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="post" action="{% url 'pedidos:enviar_mensaje_cliente' pedido.id %}">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">Cliente:</label>
                                                <p class="text-muted">{{ pedido.usuario.first_name }} {{ pedido.usuario.last_name }} - {{ pedido.usuario.email }}</p>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Asunto</label>
                                                <input type="text" name="asunto" class="form-control" 
                                                       placeholder="Ej: Actualización de tu pedido" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Mensaje</label>
                                                <textarea name="mensaje" class="form-control" rows="5" 
                                                          placeholder="Escribe tu mensaje aquí..." required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer border-secondary">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-paper-plane"></i> Enviar Mensaje
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            No se encontraron pedidos
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>

        {% comment %} Modales de eliminación por pedido {% endcomment %}
        {% for pedido in pedidos %}
        <div class="modal fade" id="modalEliminar{{ pedido.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">
                            <i class="fas fa-trash"></i> Confirmar eliminación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="post" action="{% url 'pedidos:eliminar_pedido' pedido.id %}">
                        {% csrf_token %}
                        <div class="modal-body">
                            <p>¿Seguro que deseas eliminar el pedido <strong>{{ pedido.numero_pedido }}</strong> de <strong>{{ pedido.usuario.first_name }} {{ pedido.usuario.last_name }}</strong>?</p>
                            <p class="text-warning small mb-0"><i class="fas fa-exclamation-triangle"></i> Esta acción no se puede deshacer.</p>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Modal de confirmación para acciones masivas -->
        <div class="modal fade" id="modalConfirmacionMasiva" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title" id="modalConfirmacionTitulo">
                            <i class="fas fa-exclamation-circle"></i> Confirmar Acción
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p id="modalConfirmacionMensaje"></p>
                        <p class="text-warning small mb-0" id="modalConfirmacionAdvertencia" style="display:none;">
                            <i class="fas fa-exclamation-triangle"></i> Esta acción no se puede deshacer.
                        </p>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" id="btnConfirmarAccion" class="btn btn-success">
                            <i class="fas fa-check"></i> Confirmar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de validación/error -->
        <div class="modal fade" id="modalValidacion" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">
                            <i class="fas fa-info-circle"></i> Atención
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p id="modalValidacionMensaje"></p>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar y auto-hide toasts de Bootstrap
        const toastElements = document.querySelectorAll('.toast');
        toastElements.forEach(toastEl => {
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        });

        // Select/Deselect all checkboxes
        const selectAll = document.getElementById('selectAll');
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                const checks = document.querySelectorAll('.pedido-checkbox');
                checks.forEach(c => c.checked = selectAll.checked);
            });
        }

        // Show/Hide extra fields depending on bulk action
        const accionMasiva = document.getElementById('accionMasiva');
        const nuevoEstadoWrap = document.getElementById('nuevoEstadoWrap');
        const seguimientoWrap = document.getElementById('seguimientoWrap');
        const nuevoEstado = document.getElementById('nuevoEstado');

        function updateBulkUI() {
            const accion = accionMasiva ? accionMasiva.value : '';
            const showEstado = accion === 'cambiar_estado';
            if (nuevoEstadoWrap) nuevoEstadoWrap.style.display = showEstado ? 'block' : 'none';
            const showSeguimiento = showEstado && nuevoEstado && nuevoEstado.value === 'enviado';
            if (seguimientoWrap) seguimientoWrap.style.display = showSeguimiento ? 'block' : 'none';
        }
        if (accionMasiva) accionMasiva.addEventListener('change', updateBulkUI);
        if (nuevoEstado) nuevoEstado.addEventListener('change', updateBulkUI);
        updateBulkUI();

        // Función para mostrar modal de validación
        function mostrarModalValidacion(mensaje) {
            document.getElementById('modalValidacionMensaje').textContent = mensaje;
            const modal = new bootstrap.Modal(document.getElementById('modalValidacion'));
            modal.show();
        }

        // Función para mostrar modal de confirmación
        function mostrarModalConfirmacion(mensaje, esEliminacion, callback) {
            document.getElementById('modalConfirmacionMensaje').textContent = mensaje;
            
            // Mostrar advertencia solo si es eliminación
            const advertencia = document.getElementById('modalConfirmacionAdvertencia');
            if (esEliminacion) {
                advertencia.style.display = 'block';
            } else {
                advertencia.style.display = 'none';
            }

            // Cambiar estilo del botón según la acción
            const btnConfirmar = document.getElementById('btnConfirmarAccion');
            if (esEliminacion) {
                btnConfirmar.className = 'btn btn-danger';
                btnConfirmar.innerHTML = '<i class="fas fa-trash"></i> Eliminar';
            } else {
                btnConfirmar.className = 'btn btn-success';
                btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar';
            }

            const modal = new bootstrap.Modal(document.getElementById('modalConfirmacionMasiva'));
            modal.show();

            // Limpiar listeners anteriores y agregar nuevo
            const newBtn = btnConfirmar.cloneNode(true);
            btnConfirmar.parentNode.replaceChild(newBtn, btnConfirmar);
            
            newBtn.addEventListener('click', function() {
                modal.hide();
                callback();
            });
        }

        // Botón de aplicar acción
        const btnAplicarAccion = document.getElementById('btnAplicarAccion');
        if (btnAplicarAccion) {
            btnAplicarAccion.addEventListener('click', function(e) {
                e.preventDefault();

                // Validar que se seleccionó una acción
                const accion = accionMasiva ? accionMasiva.value : '';
                if (!accion) {
                    mostrarModalValidacion('Por favor, selecciona una acción masiva.');
                    return;
                }

                // Obtener pedidos seleccionados
                const checkboxes = document.querySelectorAll('.pedido-checkbox:checked');
                if (checkboxes.length === 0) {
                    mostrarModalValidacion('Por favor, selecciona al menos un pedido.');
                    return;
                }

                // Validar estado si la acción es cambiar_estado
                if (accion === 'cambiar_estado') {
                    const estado = nuevoEstado ? nuevoEstado.value : '';
                    if (!estado) {
                        mostrarModalValidacion('Por favor, selecciona un nuevo estado.');
                        return;
                    }
                }

                // Preparar mensaje de confirmación
                let mensaje = '';
                let esEliminacion = false;
                if (accion === 'eliminar') {
                    esEliminacion = true;
                    mensaje = `¿Estás seguro de eliminar ${checkboxes.length} pedido(s)?`;
                } else if (accion === 'cambiar_estado') {
                    const estadoNombre = nuevoEstado.options[nuevoEstado.selectedIndex].text;
                    mensaje = `¿Cambiar el estado de ${checkboxes.length} pedido(s) a "${estadoNombre}"?`;
                }

                // Mostrar modal de confirmación
                mostrarModalConfirmacion(mensaje, esEliminacion, function() {
                    // Preparar formulario oculto
                    const form = document.getElementById('accionesMasivasForm');
                    const hiddenCheckboxes = document.getElementById('hiddenCheckboxes');
                    
                    // Limpiar checkboxes anteriores
                    hiddenCheckboxes.innerHTML = '';

                    // Agregar los IDs seleccionados
                    checkboxes.forEach(function(checkbox) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'pedidos[]';
                        input.value = checkbox.getAttribute('data-pedido-id');
                        hiddenCheckboxes.appendChild(input);
                    });

                    // Copiar valores de los campos visibles al formulario oculto
                    document.getElementById('hiddenAccion').value = accion;
                    if (accion === 'cambiar_estado') {
                        document.getElementById('hiddenNuevoEstado').value = nuevoEstado.value;
                        document.getElementById('hiddenNumeroSeguimiento').value = document.getElementById('numeroSeguimiento').value;
                    }

                    // Enviar formulario
                    form.submit();
                });
            });
        }
    });
</script>
{% endblock %}
