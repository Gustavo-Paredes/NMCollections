{% extends 'base/base.html' %}
{% load static %}

{% block title %}Pedido #{{ pedido.id }} - NM Collections{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pedidos_detalle.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
  <div class="dashboard-header mb-4">
    <h1 class="dashboard-title"><i class="fas fa-receipt me-2"></i> Pedido #{{ pedido.id }}</h1>
  </div>

  <div class="dashboard-main-card">
    <div class="dashboard-card-inner">
      <!-- Estado y alertas -->
      <div class="pedido-estado text-center mb-3">
        <span class="status-badge status-{{ pedido.estado }}">
          {% if pedido.estado == 'pendiente' %}<i class="fas fa-clock"></i> Pendiente de Confirmación
          {% elif pedido.estado == 'confirmado' %}<i class="fas fa-check-circle"></i> Confirmado
          {% elif pedido.estado == 'enviado' %}<i class="fas fa-shipping-fast"></i> Enviado
          {% elif pedido.estado == 'entregado' %}<i class="fas fa-check-double"></i> Entregado
          {% elif pedido.estado == 'cancelado' %}<i class="fas fa-times-circle"></i> Cancelado
          {% endif %}
        </span>
      </div>

      {% if pedido.estado == 'pendiente' %}
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <strong>Tu pedido está pendiente de confirmación.</strong> Te notificaremos cuando esté confirmado.
      </div>
      {% elif pedido.estado == 'confirmado' %}
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        <strong>¡Tu pedido ha sido confirmado!</strong> Estamos preparándolo para el envío.
      </div>
      {% elif pedido.estado == 'enviado' %}
      <div class="alert alert-info">
        <i class="fas fa-shipping-fast"></i>
        <strong>¡Tu pedido está en camino!</strong>
      </div>
      {% elif pedido.estado == 'entregado' %}
      <div class="alert alert-success">
        <i class="fas fa-check-double"></i>
        <strong>¡Pedido entregado!</strong> Gracias por tu compra.
      </div>
      {% elif pedido.estado == 'cancelado' %}
      <div class="alert alert-danger">
        <i class="fas fa-times-circle"></i>
        <strong>Pedido cancelado.</strong> {% if pedido.notas %}{{ pedido.notas }}{% endif %}
      </div>
      {% endif %}

      <!-- Meta del pedido -->
      <div class="pedido-meta-grid">
        <div class="meta-card">
          <div class="meta-label">Fecha de Pedido</div>
          <div class="meta-value">{{ pedido.fecha_creacion|date:"d/m/Y H:i" }}</div>
        </div>
        {% if pedido.fecha_actualizacion %}
        <div class="meta-card">
          <div class="meta-label">Última Actualización</div>
          <div class="meta-value">{{ pedido.fecha_actualizacion|date:"d/m/Y H:i" }}</div>
        </div>
        {% endif %}
        <div class="meta-card">
          <div class="meta-label">Estado</div>
          <div class="meta-value"><span class="status-chip status-{{ pedido.estado }}">{{ pedido.estado|capfirst }}</span></div>
        </div>
        <div class="meta-card">
          <div class="meta-label">Total</div>
          <div class="meta-value total">${{ pedido.total|floatformat:0 }}</div>
        </div>
      </div>

      <!-- Productos -->
      <div class="section-card">
        <h4 class="section-title"><i class="fas fa-shopping-bag me-2"></i> Productos ({{ pedido.productos.count }})</h4>
        {% for item in pedido.productos.all %}
        <div class="producto-row">
          <div class="producto-media">
            {% if item.carta_personalizada and item.carta_personalizada.imagen_generada %}
              <img src="{{ item.carta_personalizada.imagen_generada.url }}" alt="Carta personalizada" class="producto-img">
            {% elif item.producto.imagen %}
              <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" class="producto-img">
            {% else %}
              <div class="producto-img placeholder d-flex align-items-center justify-content-center">
                <i class="fas fa-image text-muted"></i>
              </div>
            {% endif %}
          </div>
          <div class="producto-main">
            <div class="producto-nombre">{{ item.producto.nombre }}</div>
            <div class="producto-desc text-muted">{{ item.producto.descripcion|default:''|truncatewords:20 }}</div>
            {% if item.personalizacion %}
            <span class="badge bg-info mt-2"><i class="fas fa-palette"></i> Carta Personalizada</span>
            {% endif %}
          </div>
          <div class="producto-meta text-center">
            <div class="meta-label">Cantidad</div>
            <div class="meta-value h5">{{ item.cantidad }}</div>
          </div>
          <div class="producto-precio text-center">
            <div class="meta-label">Precio</div>
            <div class="meta-value h5 text-success">${{ item.precio_unitario|floatformat:0 }}</div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Cartas personalizadas -->
      {% if productos_personalizados %}
      <div class="section-card">
        <h4 class="section-title"><i class="fas fa-magic me-2"></i> Cartas Personalizadas</h4>
        {% for item in productos_personalizados %}
        <div class="carta-card">
          <div class="carta-head">
            <i class="fas fa-id-card"></i> {{ item.carta.nombre_carta|default:"Carta sin nombre" }}
            <span class="ms-auto estado-chip estado-{{ item.carta.estado }}">{{ item.carta.estado|capfirst }}</span>
          </div>
          <div class="carta-body row g-3">
            <div class="col-md-4 text-center">
              {% if item.carta.imagen_generada %}
                <img src="{{ item.carta.imagen_generada.url }}" class="img-fluid rounded shadow" style="max-width:250px; max-height:350px;">
              {% else %}
                <div class="carta-placeholder">Imagen no disponible</div>
              {% endif %}
            </div>
            <div class="col-md-8">
              <h6 class="text-accent mb-3"><i class="fas fa-cogs"></i> Parámetros de Personalización</h6>
              {% if item.parametros %}
              <div class="row">
                {% for parametro in item.parametros %}
                <div class="col-md-6 mb-3">
                  <div class="param-card">
                    <div class="param-titulo">{{ parametro.nombre_parametro|capfirst }}</div>
                    <span class="badge bg-secondary me-2 mb-2">
                      {% if parametro.tipo_parametro == 'texto' %}<i class="fas fa-font"></i> Texto
                      {% elif parametro.tipo_parametro == 'imagen' %}<i class="fas fa-image"></i> Imagen
                      {% elif parametro.tipo_parametro == 'color' %}<i class="fas fa-palette"></i> Color
                      {% elif parametro.tipo_parametro == 'numero' %}<i class="fas fa-hashtag"></i> Número
                      {% endif %}
                    </span>
                    {% if parametro.tipo_parametro == 'color' %}
                    <div class="d-flex align-items-center mt-1">
                      <span class="swatch" style="background: {{ parametro.valor }};"></span>
                      <code class="ms-2">{{ parametro.valor }}</code>
                    </div>
                    {% else %}
                    <div class="text-muted mt-1">{{ parametro.valor|truncatewords:10 }}</div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="text-muted">No hay parámetros para esta carta.</div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Historial -->
      {% if historial %}
      <div class="section-card">
        <h4 class="section-title"><i class="fas fa-history me-2"></i> Seguimiento del Pedido</h4>
        <div class="timeline">
          {% for cambio in historial %}
          <div class="timeline-item">
            <div class="timeline-date">{{ cambio.fecha|date:"d/m/Y H:i" }}</div>
            <div class="timeline-title">
              {% if cambio.estado_nuevo == 'pendiente' %}<i class="fas fa-clock text-warning"></i> Pedido creado y pendiente
              {% elif cambio.estado_nuevo == 'confirmado' %}<i class="fas fa-check-circle text-success"></i> Pedido confirmado
              {% elif cambio.estado_nuevo == 'enviado' %}<i class="fas fa-shipping-fast text-info"></i> Pedido enviado
              {% elif cambio.estado_nuevo == 'entregado' %}<i class="fas fa-check-double text-success"></i> Pedido entregado
              {% elif cambio.estado_nuevo == 'cancelado' %}<i class="fas fa-times-circle text-danger"></i> Pedido cancelado
              {% endif %}
            </div>
            {% if cambio.notas %}<div class="mt-2 text-muted">{{ cambio.notas }}</div>{% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Acciones -->
      <div class="d-flex flex-wrap gap-2 justify-content-center mt-3">
        <a href="{% url 'pedidos:mis_pedidos' %}" class="btn btn-secondary btn-custom">
          <i class="fas fa-list"></i> Mis Pedidos
        </a>
        {% if pedido.estado == 'pendiente' %}
        <button class="btn btn-outline-danger btn-custom" data-bs-toggle="modal" data-bs-target="#cancelarPedidoModal">
          <i class="fas fa-times"></i> Cancelar Pedido
        </button>
        {% elif pedido.estado == 'enviado' %}
        <button class="btn btn-success btn-custom" data-bs-toggle="modal" data-bs-target="#confirmarEntregaModal">
          <i class="fas fa-check-double"></i> Confirmar Entrega
        </button>
        {% endif %}
        <button class="btn btn-outline-primary btn-custom" onclick="window.print()">
          <i class="fas fa-print"></i> Imprimir Recibo
        </button>
        <a href="{% url 'core:home' %}" class="btn btn-primary btn-custom">
          <i class="fas fa-home"></i> Inicio
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Modal Cancelar -->
{% if pedido.estado == 'pendiente' %}
<div class="modal fade" id="cancelarPedidoModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Cancelar Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¿Está seguro de que desea cancelar este pedido?</p>
        <p class="text-warning"><strong>Esta acción no se puede deshacer.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, mantener pedido</button>
        <form method="post" action="{% url 'pedidos:cancelar_pedido_usuario' pedido.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Sí, cancelar pedido</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Modal Confirmar Entrega -->
{% if pedido.estado == 'enviado' %}
<div class="modal fade" id="confirmarEntregaModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Confirmar Entrega</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¿Confirmas que has recibido tu pedido?</p>
        <p class="text-warning"><strong>Esta acción no se puede deshacer.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form method="post" action="{% url 'pedidos:confirmar_entrega_usuario' pedido.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-success">Sí, confirmar</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}
