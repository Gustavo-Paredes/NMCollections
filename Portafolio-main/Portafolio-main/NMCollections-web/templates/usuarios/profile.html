<!-- COLOCAR ESTE CÓDIGO EN: templates/usuarios/profile.html -->

{% extends 'base/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/usuarios_profile.css' %}">
{% endblock %}

{% block title %}Mi Perfil - {{ user.first_name }}{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="dashboard-header mb-4 d-flex align-items-center">
        <div class="me-4 position-relative">
            <div class="avatar-container" data-bs-toggle="modal" data-bs-target="#avatarModal" style="cursor: pointer;">
                {% if perfil.avatar %}
                    <img src="{{ perfil.avatar.url }}" alt="Avatar de {{ user.first_name }}" class="avatar-img">
                    <div class="avatar-overlay">
                        <i class="fas fa-camera"></i>
                    </div>
                {% else %}
                    <div class="avatar-placeholder">
                        {{ user.first_name.0 }}{{ user.last_name.0 }}
                    </div>
                    <div class="avatar-overlay">
                        <i class="fas fa-camera"></i>
                    </div>
                {% endif %}
            </div>
        </div>
        <div>
            <h1 class="dashboard-title mb-1">{{ user.first_name }} {{ user.last_name }}</h1></h1>
            <p class="dashboard-subtitle mb-0">{{ user.email }}</p>
            <span class="badge bg-success mt-2">{{ user.rol.nombre|title }}</span>
        </div>
    </div>
    <div class="dashboard-main-card" style="max-width: 520px; margin: 0 auto;">
        <div class="dashboard-card-inner">
                <form method="post" enctype="multipart/form-data" class="profile-form">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-12 mb-3">
                            <label for="username" class="form-label" style="color: #fff;">Nombre de usuario</label>
                            <input type="text" id="username" name="username" value="{{ user.username }}" class="form-control" required style="color: #fff;">
                            {% if user_form and user_form.errors.username %}
                                <div class="text-danger small mt-1">{{ user_form.errors.username|striptags }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="nombre" class="form-label" style="color: #fff;">Nombre</label>
                            <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" class="form-control" required style="color: #fff;">
                        </div>
                        <div class="col-md-6">
                            <label for="apellido" class="form-label" style="color: #fff;">Apellido</label>
                            <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" class="form-control" required style="color: #fff;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label" style="color: #fff;">Email</label>
                        <input type="email" id="email" name="email" value="{{ user.email }}" class="form-control" required style="color: #fff;">
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="telefono" class="form-label" style="color: #fff;">Teléfono</label>
                            <input type="tel" id="telefono" name="telefono" value="{{ user.telefono }}" class="form-control" style="color: #fff;">
                        </div>
                        <div class="col-md-6">
                            <label for="fecha_nacimiento" class="form-label" style="color: #fff;">Fecha de Nacimiento</label>
                            <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" value="{{ perfil.fecha_nacimiento|date:'Y-m-d' }}" class="form-control" style="color: #fff;">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-dashboard w-100">Guardar Cambios</button>
                </form>
        </div>
    </div>
</div>

<!-- Modal para cambiar/eliminar avatar -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--gris-oscuro, #232b2b); color: white;">
            <div class="modal-header" style="border-bottom: 1px solid var(--gris-medio, #333);">
                <h5 class="modal-title" id="avatarModalLabel" style="color: var(--verde-principal, #00ff88);">Foto de Perfil</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
                <button type="button" class="btn btn-avatar-action mb-3 w-100" onclick="document.getElementById('avatarFileInput').click();">
                    <i class="fas fa-upload me-2"></i>Cambiar Foto
                </button>
                {% if perfil.avatar %}
                <button type="button" class="btn btn-avatar-delete w-100" onclick="eliminarAvatar();">
                    <i class="fas fa-trash me-2"></i>Eliminar Foto
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Manejar subida de avatar
document.getElementById('avatarFileInput').addEventListener('change', function(e) {
    if (this.files && this.files[0]) {
        const formData = new FormData();
        formData.append('avatar', this.files[0]);
        formData.append('cambiar_avatar', 'true');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch('{% url "usuarios:profile" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al subir la imagen');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al subir la imagen');
        });
        
        // Cerrar modal
        const modalEl = document.getElementById('avatarModal');
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
            modalInstance.hide();
        }
    }
});

// Eliminar avatar
function eliminarAvatar() {
    if (confirm('¿Estás seguro de que quieres eliminar tu foto de perfil?')) {
        const formData = new FormData();
        formData.append('eliminar_avatar', 'true');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch('{% url "usuarios:profile" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al eliminar la imagen');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al eliminar la imagen');
        });
        
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('avatarModal')).hide();
    }
}
</script>

{% endblock %}